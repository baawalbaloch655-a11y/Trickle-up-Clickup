// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─────────────────────────────────────────────
// Users
// ─────────────────────────────────────────────

model User {
  id              String     @id @default(uuid())
  email           String     @unique
  name            String
  passwordHash    String
  avatarUrl       String?
  status          UserStatus @default(ACTIVE)
  isEmailVerified Boolean    @default(false)
  twoFaSecret     String?
  twoFaEnabled    Boolean    @default(false)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  orgMembers    OrgMember[]
  assignedTasks Task[]         @relation("TaskAssignee")
  createdTasks  Task[]         @relation("TaskCreator")
  notifications Notification[]
  refreshTokens RefreshToken[]
  uploadedFiles File[]
  auditLogs          AuditLog[]
  TaskComment        TaskComment[]
  TimeEntry          TimeEntry[]
  spaceMembers       SpaceMember[]
  favorites          Favorite[]
  channelMembers     ChannelMember[]
  conversationMember ConversationMember[]
  messages           Message[]

  @@map("users")
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}

// ─────────────────────────────────────────────
// Organizations (Multi-tenant)
// ─────────────────────────────────────────────

model Organization {
  id           String  @id @default(uuid())
  name         String
  slug         String  @unique
  logoUrl      String?
  plan         OrgPlan @default(FREE)
  tenantConfig Json?

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  members       OrgMember[]
  roles         Role[]
  lists         List[]
  notifications Notification[]
  files         File[]
  auditLogs     AuditLog[]
  Space         Space[]
  departments   Department[]
  skills        EmployeeSkill[]
  favorites     Favorite[]
  channels      Channel[]
  conversations Conversation[]

  @@map("organizations")
}

enum OrgPlan {
  FREE
  PRO
  ENTERPRISE
}

enum EmployeeStatus {
  ACTIVE
  ON_LEAVE
  SUSPENDED
  INACTIVE
}

model OrgMember {
  id     String @id @default(uuid())
  userId String
  orgId  String
  roleId String

  // HR Extensions
  title        String?
  status       EmployeeStatus @default(ACTIVE)
  capacityMins Int            @default(2400) // 40 hours default
  departmentId String?
  teamId       String?
  managerId    String?

  // Timestamps
  joinedAt  DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  // Relations
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  org          Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  role         Role            @relation(fields: [roleId], references: [id])
  department   Department?     @relation(fields: [departmentId], references: [id])
  team         Team?           @relation(fields: [teamId], references: [id])
  manager      OrgMember?      @relation("ManagerHierarchy", fields: [managerId], references: [id])
  subordinates OrgMember[]     @relation("ManagerHierarchy")
  skills       EmployeeSkill[]

  @@unique([userId, orgId])
  @@map("org_members")
}

// ─────────────────────────────────────────────
// HR & Departments
// ─────────────────────────────────────────────

model Department {
  id          String  @id @default(uuid())
  orgId       String
  name        String
  description String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  teams   Team[]
  members OrgMember[]

  @@map("departments")
}

model Team {
  id           String  @id @default(uuid())
  departmentId String
  name         String
  description  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  department Department  @relation(fields: [departmentId], references: [id], onDelete: Cascade)
  members    OrgMember[]

  @@map("teams")
}

model EmployeeSkill {
  id    String @id @default(uuid())
  orgId String
  name  String

  org     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members OrgMember[]

  @@unique([orgId, name])
  @@map("employee_skills")
}

// ─────────────────────────────────────────────
// Roles & Permissions (RBAC)
// ─────────────────────────────────────────────

model Role {
  id          String   @id @default(uuid())
  orgId       String
  name        String
  permissions String[]
  isDefault   Boolean  @default(false)
  isSystem    Boolean  @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  org     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members OrgMember[]

  @@unique([orgId, name])
  @@map("roles")
}

// ─────────────────────────────────────────────
// Auth
// ─────────────────────────────────────────────

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  tokenHash  String   @unique
  deviceInfo String?
  ipAddress  String?
  expiresAt  DateTime
  isRevoked  Boolean  @default(false)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

// ─────────────────────────────────────────────
// Lists (Formerly Projects)
// ─────────────────────────────────────────────

model List {
  id          String  @id @default(uuid())
  orgId       String
  name        String
  description String?
  color       String  @default("#6366f1")
  isArchived  Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  tasks    Task[]
  space    Space?       @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  spaceId  String?
  folder   Folder?      @relation(fields: [folderId], references: [id], onDelete: Cascade)
  folderId String?

  @@map("lists")
}

// ─────────────────────────────────────────────
// Tasks (Core Business Entity)
// ─────────────────────────────────────────────

model Task {
  id          String       @id @default(uuid())
  listId      String
  orgId       String
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  assigneeId  String?
  creatorId   String
  dueDate     DateTime?
  timeTracked Int?         @default(0)
  order       Int          @default(0)
  tags        String[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  list             List               @relation(fields: [listId], references: [id], onDelete: Cascade)
  assignee         User?              @relation("TaskAssignee", fields: [assigneeId], references: [id])
  creator          User               @relation("TaskCreator", fields: [creatorId], references: [id])
  CustomFieldValue CustomFieldValue[]
  TaskComment      TaskComment[]
  TimeEntry        TimeEntry[]

  @@map("tasks")
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  IN_REVIEW
  DONE
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ─────────────────────────────────────────────
// Notifications
// ─────────────────────────────────────────────

model Notification {
  id        String               @id @default(uuid())
  userId    String
  orgId     String
  type      NotificationType
  category  NotificationCategory @default(PRIMARY)
  title     String
  body      String
  isRead    Boolean              @default(false)
  isCleared Boolean              @default(false)
  metadata  Json?

  createdAt DateTime @default(now())

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

enum NotificationCategory {
  PRIMARY
  OTHER
  LATER
}

enum NotificationType {
  TASK_ASSIGNED
  TASK_UPDATED
  TASK_COMPLETED
  MEMBER_INVITED
  MEMBER_JOINED
  LIST_CREATED
  MENTION
  SYSTEM
  COMMENT_REPLY
  COMMENT_ASSIGNED
}

// ─────────────────────────────────────────────
// Files
// ─────────────────────────────────────────────

model File {
  id           String @id @default(uuid())
  orgId        String
  uploadedBy   String
  key          String @unique
  url          String
  size         Int
  mimetype     String
  originalName String

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  uploader User         @relation(fields: [uploadedBy], references: [id])

  @@map("files")
}

// ─────────────────────────────────────────────
// Audit Logs
// ─────────────────────────────────────────────

model AuditLog {
  id         String      @id @default(uuid())
  orgId      String
  userId     String
  action     AuditAction
  resource   String
  resourceId String?
  metadata   Json?
  ipAddress  String?

  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  INVITE
  ROLE_CHANGE
  VIEW
}

// ─────────────────────────────────────────────
// ENHANCED ENTERPRISE FEATURES (ClickUp Parity)
// ─────────────────────────────────────────────

// --- WORKSPACE HIERARCHY ---

model Space {
  id          String  @id @default(uuid())
  orgId       String
  name        String
  description String?
  color       String  @default("#000000")
  isPrivate   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org     Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  folders Folder[]
  lists   List[]
  members SpaceMember[]

  @@map("spaces")
}

model SpaceMember {
  id      String @id @default(uuid())
  spaceId String
  userId  String

  space Space @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId])
  @@map("space_members")
}

model Folder {
  id      String @id @default(uuid())
  spaceId String
  orgId   String
  name    String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  space Space  @relation(fields: [spaceId], references: [id], onDelete: Cascade)
  lists List[]

  @@map("folders")
}

// --- CUSTOMIZATION & WORKFLOW ---

model CustomField {
  id      String          @id @default(uuid())
  orgId   String
  name    String
  type    CustomFieldType
  options Json? // For dropdowns, tags, etc.

  values CustomFieldValue[]

  @@map("custom_fields")
}

enum CustomFieldType {
  TEXT
  NUMBER
  DROPDOWN
  DATE
  CHECKBOX
  USER
}

model CustomFieldValue {
  id            String @id @default(uuid())
  taskId        String
  customFieldId String
  value         Json // Stores the actual value

  customField CustomField @relation(fields: [customFieldId], references: [id], onDelete: Cascade)
  task        Task        @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([taskId, customFieldId])
  @@map("custom_field_values")
}

// --- COLLABORATION ---

model TaskComment {
  id        String   @id @default(uuid())
  taskId    String
  userId    String
  content   String // Rich text content
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("task_comments")
}

// --- TIME TRACKING ---

model TimeEntry {
  id          String    @id @default(uuid())
  taskId      String
  userId      String
  startTime   DateTime  @default(now())
  endTime     DateTime?
  duration    Int? // In seconds
  description String?

  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("time_entries")
}

// --- AUTOMATION ENGINE ---

model AutomationRule {
  id         String  @id @default(uuid())
  orgId      String
  listId     String? // If null, applies to whole Org or Space
  name       String
  trigger    Json // { type: "STATUS_CHANGE", from: "TODO", to: "DONE" }
  conditions Json? // { priority: "HIGH" }
  isActive   Boolean @default(true)

  actions AutomationAction[]

  @@map("automation_rules")
}

model AutomationAction {
  id      String @id @default(uuid())
  ruleId  String
  type    String // e.g., "ASSIGN_USER", "SEND_EMAIL", "WEBHOOK"
  payload Json // Configuration for the action

  rule AutomationRule @relation(fields: [ruleId], references: [id], onDelete: Cascade)

  @@map("automation_actions")
}

// --- FAVORITES ---

model Favorite {
  id         String       @id @default(uuid())
  userId     String
  orgId      String
  entityType FavoriteType
  entityId   String // ID of Space, Folder, List, or Task

  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, entityType, entityId])
  @@map("favorites")
}

enum FavoriteType {
  SPACE
  FOLDER
  LIST
  TASK
}

// --- CHANNELS & MESSAGING ---

model Channel {
  id          String  @id @default(uuid())
  orgId       String
  name        String
  description String?
  isPrivate   Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  org      Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members  ChannelMember[]
  messages Message[]

  @@map("channels")
}

model ChannelMember {
  id        String @id @default(uuid())
  channelId String
  userId    String
  role      String @default("MEMBER") // ADMIN, MEMBER

  channel Channel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([channelId, userId])
  @@map("channel_members")
}

model Conversation {
  id      String  @id @default(uuid())
  orgId   String
  isGroup Boolean @default(false)
  name    String? // Optional name for group DMs

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  org      Organization         @relation(fields: [orgId], references: [id], onDelete: Cascade)
  members  ConversationMember[]
  messages Message[]

  @@map("conversations")
}

model ConversationMember {
  id             String @id @default(uuid())
  conversationId String
  userId         String

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([conversationId, userId])
  @@map("conversation_members")
}

model Message {
  id             String  @id @default(uuid())
  content        String
  userId         String
  channelId      String?
  conversationId String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel      Channel?      @relation(fields: [channelId], references: [id], onDelete: Cascade)
  conversation Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("messages")
}
